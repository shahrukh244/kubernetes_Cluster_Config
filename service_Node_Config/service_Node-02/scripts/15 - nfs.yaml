---
- name: NFS Server Setup (Safe, Verified)
  hosts: localhost
  become: true
  gather_facts: true

  tasks:

    # -------- NFS (Safe, Verified) --------

    - name: Check if NFS server is installed
      ansible.builtin.command: exportfs -v
      register: nfs_check
      failed_when: false
      changed_when: false

    - name: Install NFS server (only if missing)
      ansible.builtin.apt:
        name: nfs-kernel-server
        state: present
        update_cache: yes
      when: nfs_check.rc != 0

    - name: Ensure NFS export directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: 1000
        group: 1000
        mode: "0777"
      loop:
        - /shares/kubernetes/StorageClass/Delete
        - /shares/kubernetes/StorageClass/Retain

    - name: Configure /etc/exports
      ansible.builtin.copy:
        dest: /etc/exports
        owner: root
        group: root
        mode: "0644"
        backup: yes
        content: |
          /shares/kubernetes/StorageClass/Delete 10.0.0.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000,no_subtree_check)
          /shares/kubernetes/StorageClass/Retain 10.0.0.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000,no_subtree_check)

    - name: Validate NFS exports
      ansible.builtin.command: exportfs -rav
      register: exportfs_validate
      changed_when: false

    - name: Enable and restart NFS server (only if exports valid)
      ansible.builtin.service:
        name: nfs-kernel-server
        state: restarted
        enabled: true
      when: exportfs_validate.rc == 0

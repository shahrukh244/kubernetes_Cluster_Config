---
- name: DRBD setup + sync + monitor
  hosts:
    - svc-1.kube.lan
    - svc-2.kube.lan
  become: true
  gather_facts: true
  serial: 0

  vars:
    vg_name: drbd_vg
    lv_name: drbd_lv
    drbd_res: kube
    drbd_device: /dev/drbd0
    backing_lv: "/dev/{{ vg_name }}/{{ lv_name }}"
    monitor_script: "{{ ansible_env.HOME }}/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/scripts/DRBD+NFS/02-drbd-disk-moniter.py"

  ##################################################
  # VERIFY BACKING STORAGE
  ##################################################
  tasks:
    - name: Verify backing LV exists
      stat:
        path: "{{ backing_lv }}"
      register: lv_stat

    - name: Abort if backing LV missing
      fail:
        msg: "Backing LV {{ backing_lv }} missing on {{ inventory_hostname }}"
      when: not lv_stat.stat.exists

    ##################################################
    # INSTALL DRBD
    ##################################################
    - name: Install DRBD packages
      apt:
        name:
          - drbd-utils
          - nfs-common
          - rpcbind
        state: present
        update_cache: yes

    - name: Load DRBD kernel module
      modprobe:
        name: drbd
        state: present

    - name: Ensure DRBD loads at boot
      copy:
        dest: /etc/modules-load.d/drbd.conf
        content: "drbd\n"
        mode: '0644'

    ##################################################
    # DRBD CONFIG
    ##################################################
    - name: Install DRBD resource file
      copy:
        src: kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/drbd-nfs/kube.res
        dest: /etc/drbd.d/kube.res
        owner: root
        group: root
        mode: '0644'

    - name: Validate DRBD configuration
      command: drbdadm dump {{ drbd_res }}
      changed_when: false

    ##################################################
    # DRBD INITIALIZATION
    ##################################################
    - name: Check DRBD status
      command: drbdadm status {{ drbd_res }}
      register: drbd_status
      failed_when: false
      changed_when: false

    - name: Create DRBD metadata (first time only)
      command: drbdadm create-md {{ drbd_res }}
      when: drbd_status.rc != 0

    - name: Bring DRBD resource up
      command: drbdadm up {{ drbd_res }}
      changed_when: false

    ##################################################
    # PROMOTION (svc-1 ONLY)
    ##################################################
    - name: Promote svc-1 to Primary
      command: drbdadm primary --force {{ drbd_res }}
      when: inventory_hostname == "svc-1.kube.lan"
      changed_when: false

##################################################
# DRBD SYNC MONITOR (CUSTOM SCRIPT)
##################################################
- name: Verify DRBD disk monitor script exists
  stat:
    path: "{{ monitor_script }}"
  register: monitor_stat

- name: Fail if DRBD disk monitor script missing
  fail:
    msg: "DRBD monitor script not found: {{ monitor_script }}"
  when: not monitor_stat.stat.exists

- name: Ensure DRBD monitor script is executable
  file:
    path: "{{ monitor_script }}"
    mode: '0755'

- name: Wait for DRBD sync using custom monitor script
  command: python3 {{ monitor_script }}
  register: monitor_result
  retries: 60
  delay: 10
  until: monitor_result.rc == 0
  changed_when: false


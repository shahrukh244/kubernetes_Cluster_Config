---
- name: Verify and create LVM for DRBD (rerun-safe)
  hosts:
    - svc-1.kube.lan
    - svc-2.kube.lan
  become: yes
  gather_facts: false
  serial: 0

  vars:
    disk: /dev/nvme0n2
    vg_name: drbd_vg
    lv_name: drbd_lv
    lv_size: 5G

  tasks:
    - name: Verify disk exists
      stat:
        path: "{{ disk }}"
      register: disk_stat

    - name: Abort if disk does not exist
      fail:
        msg: "Disk {{ disk }} does not exist on {{ inventory_hostname }}"
      when: not disk_stat.stat.exists

    - name: Ensure LVM tools are installed
      apt:
        name: lvm2
        state: present
        update_cache: yes

    # This task is SAFE:
    # - Creates PV if missing
    # - Creates VG if missing
    # - Does NOTHING if already exists
    - name: Ensure VG exists (creates PV if needed)
      lvg:
        vg: "{{ vg_name }}"
        pvs: "{{ disk }}"
        state: present

    # This task is SAFE and idempotent
    - name: Ensure LV exists
      lvol:
        vg: "{{ vg_name }}"
        lv: "{{ lv_name }}"
        size: "{{ lv_size }}"
        state: present

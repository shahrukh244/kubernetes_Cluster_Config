---
- name: Full Ubuntu system setup with services
  hosts: localhost
  become: true

  tasks:

    # -------- SSH --------
    - name: Allow root login via password and key
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
        backrefs: yes
      loop:
        - { regexp: '^#?PermitRootLogin\s+.*', line: 'PermitRootLogin yes' }
        - { regexp: '^#?PasswordAuthentication\s+.*', line: 'PasswordAuthentication yes' }
        - { regexp: '^#?UsePAM\s+.*', line: 'UsePAM yes' }

    - name: Set root password
      ansible.builtin.user:
        name: root
        password: "{{ '123' | password_hash('sha512') }}"

    - name: Restart SSH service
      ansible.builtin.service:
        name: ssh
        state: restarted
        enabled: true

    # -------- SSH KEYGEN --------
    - name: Ensure /root/.ssh directory exists
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Generate ed25519 SSH key for root (no passphrase)
      ansible.builtin.command: ssh-keygen -t ed25519 -f /root/.ssh/id_ed25519 -N ""
      args:
        creates: /root/.ssh/id_ed25519

    - name: Set private key permissions
      ansible.builtin.file:
        path: /root/.ssh/id_ed25519
        mode: "0600"

    - name: Set public key permissions
      ansible.builtin.file:
        path: /root/.ssh/id_ed25519.pub
        mode: "0644"
        
    # -------- Swap --------
    # 1. Check if swap is enabled at runtime
    - name: Check runtime swap status
      ansible.builtin.command: swapon --noheadings
      register: swap_runtime
      changed_when: false
      failed_when: false

    # 2. Disable swap ONLY if enabled
    - name: Disable swap if enabled
      ansible.builtin.command: swapoff -a
      when: swap_runtime.stdout | trim != ""

    # 3. Detect ACTIVE (not commented) swap entry in fstab
    - name: Detect active swap entry in fstab
      ansible.builtin.shell: |
        awk '!/^[[:space:]]*#/ && $1 == "/swap.img" { print }' /etc/fstab
      register: swap_fstab_active
      changed_when: false

    # 4. Comment swap entry ONLY if active
    - name: Comment swap entry in fstab
      ansible.builtin.lineinfile:
        path: /etc/fstab
        regexp: '^[[:space:]]*/swap\.img.*$'
        line: '#/swap.img       none    swap    sw      0       0'
      when: swap_fstab_active.stdout | trim != ""

    # 5. Final verification (read-only)
    - name: Final swap verification
      ansible.builtin.command: swapon --show
      changed_when: false

    # -------- UFW --------
    - name: Disable UFW
      ansible.builtin.service:
        name: ufw
        state: stopped
        enabled: false
      ignore_errors: yes

    # -------- Keepalived --------
    - name: Install Keepalived
      ansible.builtin.apt:
        name: keepalived
        state: present
        update_cache: yes

    - name: Enable ip_nonlocal_bind
      ansible.builtin.sysctl:
        name: net.ipv4.ip_nonlocal_bind
        value: "1"
        state: present
        reload: yes

    - name: Ensure keepalived config directory exists
      ansible.builtin.file:
        path: /etc/keepalived
        state: directory
        mode: "0755"

    - name: Copy keepalived.conf
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/keepalived/keepalived.conf
        dest: /etc/keepalived/keepalived.conf
        mode: "0644"

    - name: Enable and start keepalived
      ansible.builtin.systemd:
        name: keepalived
        enabled: yes
        state: started

    # -------- BIND --------
    - name: Install BIND9
      ansible.builtin.apt:
        name: bind9
        state: present
        update_cache: yes

    - name: Ensure BIND zones directory exists
      ansible.builtin.file:
        path: /etc/bind/zones
        state: directory
        mode: 0755

    - name: Copy named.conf.options
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/dns/named.conf.options
        dest: /etc/bind/named.conf.options
        backup: yes

    - name: Copy named.conf.local
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/dns/named.conf.local
        dest: /etc/bind/named.conf.local
        backup: yes

    - name: Copy forward zone
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/dns/zones/db.kube.lan
        dest: /etc/bind/zones/db.kube.lan
        backup: yes

    - name: Copy reverse zone
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/dns/zones/db.reverse
        dest: /etc/bind/zones/db.reverse
        backup: yes

    - name: Restart BIND9
      ansible.builtin.service:
        name: bind9
        state: restarted
        enabled: true

    # -------- DHCP --------
    - name: Install DHCP server
      ansible.builtin.apt:
        name: isc-dhcp-server
        state: present
        update_cache: yes

    - name: Configure DHCP interface
      ansible.builtin.lineinfile:
        path: /etc/default/isc-dhcp-server
        regexp: '^INTERFACESv4='
        line: 'INTERFACESv4="ens34"'

    - name: Copy dhcpd.conf
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/dhcp/dhcpd.conf
        dest: /etc/dhcp/dhcpd.conf
        backup: yes

    - name: Restart DHCP server
      ansible.builtin.service:
        name: isc-dhcp-server
        state: restarted
        enabled: true

    # -------- IP Forwarding & NAT --------
    - name: Enable IP forwarding
      ansible.builtin.sysctl:
        name: net.ipv4.ip_forward
        value: "1"
        state: present
        reload: yes

    - name: NAT POSTROUTING rule
      ansible.builtin.iptables:
        table: nat
        chain: POSTROUTING
        source: 10.0.0.0/24
        out_interface: ens32
        jump: MASQUERADE

    - name: FORWARD rule LAN to WAN
      ansible.builtin.iptables:
        chain: FORWARD
        in_interface: ens34
        out_interface: ens32
        jump: ACCEPT

    - name: FORWARD established connections
      ansible.builtin.iptables:
        chain: FORWARD
        in_interface: ens32
        out_interface: ens34
        ctstate: RELATED,ESTABLISHED
        jump: ACCEPT

    - name: Install iptables-persistent
      ansible.builtin.apt:
        name: iptables-persistent
        state: present
        update_cache: yes

    - name: Save iptables rules
      ansible.builtin.command: netfilter-persistent save
      ignore_errors: yes

    # -------- HAProxy --------
    - name: Install HAProxy
      ansible.builtin.apt:
        name: haproxy
        state: present
        update_cache: yes

    - name: Copy haproxy.cfg
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/haproxy/haproxy.cfg
        dest: /etc/haproxy/haproxy.cfg
        backup: yes

    - name: Restart HAProxy
      ansible.builtin.service:
        name: haproxy
        state: restarted
        enabled: true

    # -------- NFS --------
    - name: Install NFS server
      ansible.builtin.apt:
        name: nfs-kernel-server
        state: present
        update_cache: yes

    - name: Create NFS directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: "0777"
        owner: 1000
        group: 1000
      loop:
        - /shares/kubernetes/StorageClass/Delete
        - /shares/kubernetes/StorageClass/Retain

    - name: Configure exports
      ansible.builtin.copy:
        dest: /etc/exports
        content: |
          /shares/kubernetes/StorageClass/Delete 10.0.0.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000,no_subtree_check)
          /shares/kubernetes/StorageClass/Retain 10.0.0.0/24(rw,sync,all_squash,anonuid=1000,anongid=1000,no_subtree_check)

    - name: Export NFS shares
      ansible.builtin.command: exportfs -ra

    - name: Restart NFS server
      ansible.builtin.service:
        name: nfs-kernel-server
        state: restarted
        enabled: true

    # -------- Chrony & Timezone --------
    - name: Set timezone
      ansible.builtin.command: timedatectl set-timezone Asia/Kolkata

    - name: Install chrony
      ansible.builtin.apt:
        name: chrony
        state: present
        update_cache: yes

    - name: Copy chrony.conf
      ansible.builtin.copy:
        src: /root/kubernetes_Cluster_Config/service_Node_Config/service_Node-01/config_Files/chrony/chrony.conf
        dest: /etc/chrony/chrony.conf
        backup: yes

    - name: Restart chrony
      ansible.builtin.service:
        name: chrony
        state: restarted
        enabled: true

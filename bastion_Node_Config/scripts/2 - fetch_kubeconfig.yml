---
- name: Fetch and configure kubeconfig from Kubernetes control plane
  hosts: localhost
  become: false
  vars:
    master_ip: "10.0.0.211"
    bastion_ip: "10.0.0.1"
    kubeconfig_path: "{{ ansible_env.HOME }}/.kube/config"
    expected_server_url: "https://{{ bastion_ip }}:6443"

  tasks:
    - name: Ensure ~/.kube directory exists
      file:
        path: "{{ ansible_env.HOME }}/.kube"
        state: directory
        mode: '0700'

    - name: Fetch admin.conf from control plane node ({{ master_ip }})
      delegate_to: "{{ master_ip }}"
      delegate_facts: false
      vars:
        ansible_user: root
        ansible_ssh_common_args: "-o StrictHostKeyChecking=no"
      slurp:
        src: /etc/kubernetes/admin.conf
      register: remote_admin_conf
      changed_when: false

    - name: Decode and modify kubeconfig server URL
      set_fact:
        raw_kubeconfig: "{{ remote_admin_conf.content | b64decode }}"
        modified_kubeconfig: "{{ remote_admin_conf.content | b64decode | regex_replace('server: https://[^:]*:6443', 'server: ' + expected_server_url) }}"

    - name: Check if kubeconfig already exists and matches desired content
      stat:
        path: "{{ kubeconfig_path }}"
      register: kubeconfig_stat

    - name: Read current kubeconfig (if exists)
      slurp:
        src: "{{ kubeconfig_path }}"
      register: current_kubeconfig_slurp
      when: kubeconfig_stat.stat.exists
      changed_when: false

    - name: Set fact for current content (or empty)
      set_fact:
        current_content: "{{ (current_kubeconfig_slurp.content | b64decode) if kubeconfig_stat.stat.exists else '' }}"

    - name: Write kubeconfig only if changed
      copy:
        content: "{{ modified_kubeconfig }}"
        dest: "{{ kubeconfig_path }}"
        mode: '0600'
      when: current_content != modified_kubeconfig
      register: kubeconfig_written

    - name: Report kubeconfig status
      debug:
        msg: >
          Kubeconfig {{ (kubeconfig_written.changed | default(false)) | ternary('UPDATED', 'UNCHANGED') }}.
          Server URL set to: {{ expected_server_url }}

    - name: Verify cluster access with kubectl
      command: kubectl get nodes
      register: kubectl_result
      changed_when: false
      failed_when: kubectl_result.rc != 0

    - name: Show kubectl output
      debug:
        msg: |
          Cluster nodes:
          {{ kubectl_result.stdout }}
